---
title: "Telco Customer Churn"
author: "Marc Fort√≥ Cornella & Javier Herrer Torres"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
editor_options:
  chunk_output_type: console
subtitle: 'SIM - Assignment 2'
classoption: a4paper
---

GitHub was used as Version Control System for this project.

The contribution of each member is visible through the following repository: https://github.com/marcforto14/Telco_Customer_Churn

And the task distribution: https://github.com/users/marcforto14/projects/1

```{r}
library(car)
library(missMDA)
library(ggplot2)
library(FactoMineR)
library(chemometrics)
rm(list = ls())
customer_churn <- read.csv("WA_Fn-UseC_-Telco-Customer-Churn.csv")
par(mfrow = c(1, 1))
```

# Data Preparation

## Univariate Descriptive Analysis

### Qualitative and quantitative

No structural errors were found (coding errors, trailing blanks in labels, lower/upper case consistency, etc.).

Data types were properly adapted to categorical when required (using the `as.factor` function).

Original numeric variables corresponding to qualitative concepts (`SeniorCitizen`) were converted to factors.

```{r}
customer_churn$gender <- as.factor(customer_churn$gender)
customer_churn$SeniorCitizen <- factor(
  customer_churn$SeniorCitizen,
  labels = c("No", "Yes")
)
customer_churn$Partner <- as.factor(customer_churn$Partner)
customer_churn$Dependents <- as.factor(customer_churn$Dependents)
customer_churn$PhoneService <- as.factor(customer_churn$PhoneService)
customer_churn$MultipleLines <- as.factor(customer_churn$MultipleLines)
customer_churn$InternetService <- as.factor(customer_churn$InternetService)
customer_churn$OnlineSecurity <- as.factor(customer_churn$OnlineSecurity)
customer_churn$OnlineBackup <- as.factor(customer_churn$OnlineBackup)
customer_churn$DeviceProtection <- as.factor(customer_churn$DeviceProtection)
customer_churn$TechSupport <- as.factor(customer_churn$TechSupport)
customer_churn$StreamingTV <- as.factor(customer_churn$StreamingTV)
customer_churn$StreamingMovies <- as.factor(customer_churn$StreamingMovies)
customer_churn$Contract <- as.factor(customer_churn$Contract)
customer_churn$PaperlessBilling <- as.factor(customer_churn$PaperlessBilling)
customer_churn$PaymentMethod <- as.factor(customer_churn$PaymentMethod)
customer_churn$Churn <- as.factor(customer_churn$Churn)
```


Original numeric variables corresponding to real quantitative concepts (`MonthlyCharges` and `tenure`) are kept as numeric but additional factors are created as discretization of each numeric variable (`f.MonthlyCharges` and `f.tenure`).

```{r}
customer_churn$f.MonthlyCharges <- cut(
  customer_churn$MonthlyCharges,
  breaks = quantile(
    customer_churn$MonthlyCharges,
    probs = c(0, 0.25, 0.5, 0.75, 1)
  ),
  labels = c("Low", "Medium", "High", "Very high"),
  include.lowest = TRUE
)
customer_churn$f.tenure <- cut(
  customer_churn$tenure,
  breaks = quantile(
    customer_churn$tenure,
    probs = c(0, 0.25, 0.5, 0.75, 1)
  ),
  labels = c("Very short", "Short", "Long", "Very long"),
  include.lowest = TRUE
)
```

### Data quality report

*variable 2: gender*

This is a binary categorical variable with a nearly balanced distribution between females and males. It contains no missing values thus imputation is not needed.
```{r out.width="50%"}
prop.table(table(customer_churn$gender))

# Missing values
sum(is.na(customer_churn$gender))
```

*variable 3: SeniorCitizen*

This is a binary categorical variable. It indicates that 84% of the customers are not senior citizens. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$SeniorCitizen))

# Missing values
sum(is.na(customer_churn$SeniorCitizen))
```

*variable 4: Partner*

This is a binary categorical variable with a nearly balanced distribution between customers that has a partner or not. It contains no missing values thus imputation is not needed.
```{r out.width="50%"}
prop.table(table(customer_churn$Partner))

# Missing values
sum(is.na(customer_churn$Partner))
```

*variable 5: Dependents*

This is a binary categorical variable. It indicates that 70% of the customers have dependents. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$Dependents))

# Missing values
sum(is.na(customer_churn$Dependents))
```

*variable 6: tenure*

tenure is a numerical variable with 0 NA's.  Then we used a Boxplot to visualize the distribution of the values of this variable. The variable has no outliers.
```{r out.width="50%"}
# Missing values
sum(is.na(customer_churn$tenure))
# Univariant Outliers
length(Boxplot(customer_churn$tenure, id = list(n = Inf)))
```

*variable 7: PhoneService*

This is a binary categorical variable. It indicates that 90% of the customers have a phone service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$PhoneService))

# Missing values
sum(is.na(customer_churn$PhoneService))
```

*variable 8: MultipleLines*

This is a categorical variable with three levels. It indicates that 48% of the customers do not have multiple lines, 42% do have multiple lines, and the remaining 10% do not have phone service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$MultipleLines))

# Missing values
sum(is.na(customer_churn$MultipleLines))
```

*variable 9: InternetService*

This is a categorical variable with three levels. It indicates that 34% of the customers have DSL, 44% have Fiber optic, and the remaining 22% do not have internet service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$InternetService))

# Missing values
sum(is.na(customer_churn$InternetService))
```

*variable 10: OnlineSecurity*

This is a categorical variable with three levels. It indicates that 50% of the customers have no online security, 29% have online security, and the remaining 22% do not have internet service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$OnlineSecurity))

# Missing values
sum(is.na(customer_churn$OnlineSecurity))
```

*variable 11: OnlineBackup*

This is a categorical variable with three levels. It indicates that 44% of the customers have no online backup, 34% have online backup, and the remaining 22% do not have internet service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$OnlineBackup))

# Missing values
sum(is.na(customer_churn$OnlineBackup))
```

*variable 12: DeviceProtection*

This is a categorical variable with three levels. It indicates that 44% of the customers have no device protection, 34% have device protection, and the remaining 22% do not have internet service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$DeviceProtection))

# Missing values
sum(is.na(customer_churn$DeviceProtection))
```

*variable 13: TechSupport*

This is a categorical variable with three levels. It indicates that 49% of the customers have no tech support, 29% have tech support, and the remaining 22% do not have internet service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$TechSupport))

# Missing values
sum(is.na(customer_churn$TechSupport))
```

*variable 14: StreamingTV*

This is a categorical variable with three levels. It indicates that 40% of the customers have no  streaming TV, 38% have streaming TV, and the remaining 22% do not have internet service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$StreamingTV))

# Missing values
sum(is.na(customer_churn$StreamingTV))
```

*variable 15: StreamingMovies*

This is a categorical variable with three levels. It indicates that 40% of the customers have no streaming movies, 39% have streaming movies, and the remaining 22% do not have internet service. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$StreamingMovies))

# Missing values
sum(is.na(customer_churn$StreamingMovies))
```

*variable 16: Contract*

This is a categorical variable with three levels. It indicates that 55% of the customers have a Month-to-month contract term, 21% have a One year contract term, and the remaining 24% have a Two year contract term. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$Contract))

# Missing values
sum(is.na(customer_churn$Contract))
```

*variable 17: PaperlessBilling*

This is a binary categorical variable. It indicates that 59% of the customers have a paperless billing. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$PaperlessBilling))

# Missing values
sum(is.na(customer_churn$PaperlessBilling))
```

*variable 18: PaymentMethod*

This is a categorical variable with four levels. Electronic check appears to be the most frequently used method, followed by mailed check, credit card (automatic), and bank transfer (automatic) similarly distributed. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$PaymentMethod))

# Missing values
sum(is.na(customer_churn$PaymentMethod))
```

*variable 19: MonthlyCharges*

MonthlyCharges is a numerical variable with 0 NA's. We used a Boxplot to visualize the distribution of the values of this variable. The variable has no outliers.
```{r out.width="50%"}
# Missing values
sum(is.na(customer_churn$MonthlyCharges))
# Univariant Outliers
length(Boxplot(customer_churn$MonthlyCharges, id = list(n = Inf)))
```

*variable 20: TotalCharges*

TotalCharges is a numerical variable with 11 NA's. These NA's correspond to customers with 0 month of tenure with the company. We will then equal their TotalCharges to 0.  We used a Boxplot to visualize the distribution of the values of this variable. The variable has no outliers. We create an additional ordinal TotalCharges factor "f.TotalCharges" to create a discretisation according to the quartiles.
```{r out.width="50%"}
# Missing values
sum(is.na(customer_churn$TotalCharges))
ll_na <- which(is.na(customer_churn$TotalCharges))
customer_churn[ll_na,]
customer_churn$TotalCharges[ll_na] = 0

# Univariant Outliers
length(Boxplot(customer_churn$TotalCharges, id = list(n = Inf)))

customer_churn$f.TotalCharges <- cut(
  customer_churn$TotalCharges,
  breaks = quantile(
    customer_churn$TotalCharges,
    probs = c(0, 0.25, 0.5, 0.75, 1)
  ),
  labels = c("Low", "Medium", "High", "Very high"),
  include.lowest = TRUE
)
```

*variable 21: Churn*

This is a binary categorical target variable. It indicates that 73% of the customers do not churned. There are no missing values, so imputation is not required.
```{r out.width="50%"}
prop.table(table(customer_churn$Churn))

# Missing values
sum(is.na(customer_churn$Churn))
```

**Inconsistencies**

There are no inconsistencies on the Phone Service and Internet Service variables. 
```{r out.width="50%"}
# Phone Service
sum(customer_churn$PhoneService == "No")
sum(customer_churn$PhoneService == "No" | customer_churn$MultipleLines == "No internet service")
# Internet Service
sum(customer_churn$InternetService == "No")
sum(customer_churn$InternetService == "No" | customer_churn$OnlineSecurity == "No internet service" | customer_churn$OnlineBackup == "No internet service" | customer_churn$DeviceProtection == "No internet service" | customer_churn$TechSupport == "No internet service" | customer_churn$StreamingTV == "No internet service" | customer_churn$StreamingMovies == "No internet service")
```

**Variables**

After exploring all variables, only 'TotalCharges' exhibits missing data, placing it last in terms of missingness. No variables show univariate outliers, suggesting minimal noise in the dataset.

**Multivariate Outliers**

Moutlier is applied on the 3 only numerical variables to find multivariate outliers. A threshold of 2% is chosen as significance level because it already returns a significant amount of outliers, more exactly around 2.5% of instances. It is chosen to delete these outliers from the data set for the rest of the project. Almost all of these outliers correspond to customers with Very Long tenure, Low Monthly Charges and Medium/High Total Charges.
```{r out.width="50%"}
res.out <- Moutlier(customer_churn[, c(6,19,20)], quantile = 0.98, col = "blue")
#which((res.out$md > res.out$cutoff) & (res.out$rd > res.out$cutoff))
length(which((res.out$md > res.out$cutoff) & (res.out$rd > res.out$cutoff))) / 7043

par(mfrow = c(1, 1))
plot(res.out$md, res.out$rd)
abline(h = res.out$cutoff, col = "red")
abline(v = res.out$cutoff, col = "red")
# summary(house_prices[which((res.out$md > res.out$cutoff) & (res.out$rd > res.out$cutoff)), ])
# summary(house_prices)
customer_churn <- customer_churn[-which((res.out$md > res.out$cutoff) & (res.out$rd > res.out$cutoff)), ]
```

# Split data

```{r}
set.seed(123)
train_index <- sample(
  seq_len(nrow(customer_churn)),
  size = floor(0.8 * nrow(customer_churn))
)

customer_churn_test <- customer_churn[-train_index, ]
customer_churn <- customer_churn[train_index, ]
```

# Exploratory Data Analysis

The most common number of months which the customer has stayed in the company is very short and the histogram shows a U shape distribution. This is, most clients stay short or long time, and not medium. With clear predominance of the first group (very short tenure).

```{r}
library(ggplot2)

ggplot(customer_churn, aes(x = tenure)) +
  geom_histogram(bins = 20) +
  labs(x = "Tenure (months)", y = "Count", title = "Histogram of tenure")
```

Clients who leave have higher monthly charges than those who don't leave.

```{r}
ggplot(customer_churn, aes(x = Churn, y = MonthlyCharges)) +
  geom_boxplot() +
  labs(
    x = "Churn",
    y = "Monthly charges($)",
    title = "Boxplot of monthly charges by churn"
  )
```

Clients who leave have mostly a month to month contract term.

```{r}
ggplot(customer_churn, aes(x = Contract, fill = Churn)) +
  geom_bar(position = "dodge") +
  labs(
    x = "Contract type",
    y = "Count",
    title = "Barplot of contract type by churn"
  )
```

Clients who leave have are charged a low total amount and high monthly amount.

```{r}
ggplot(
  customer_churn,
  aes(
    x = TotalCharges,
    y = MonthlyCharges,
    color = Churn
  )
) +
  geom_point() +
  labs(
    x = "Total charges ($)",
    y = "Monthly charges ($)",
    title = "Scatterplot of total and monthly charges by churn"
  )
```

Client tenure and monthly charged amount are posivly correlated but not strongly.

```{r}
cor(customer_churn[, c("tenure", "MonthlyCharges")])
```

There is no significant association between gender and churn.

```{r}
chisq.test(customer_churn$gender, customer_churn$Churn)
```

# Profiling and Feature Selection

The Categorical Data Analysis shows the 5 most important categorical variables to predict the Customer Churn are the contract type, tenure (new categorical), online security, tech support and internet service. Diving deep into them, customers who don't leave are assocated with a two year contract, long tenure and no internet service. On the other hand, churn is associated with a monthly contract, no online security nor tech support, fiber optic and very short tenure.

Regarding the quantitative variables, monthly charges is the one which contributes the most to customer churn, while total charges and tenure have the opposite effect (negative correlation).

```{r}
catdes(customer_churn, num.var = 21)
```

# Churn Modeling

## Numeric variables

From the total charges histogram, the variable is observed as right-skewed, meaning that it has a long tail on the right side of the distribution. This can cause problems for the glm such as violating the assumption of homoscedasticity (the variance of the error term is constant across different values of the predictor variable) affecting the accuracy and reliability of the model estimates. Thus, a log transformation is applied; and a small constant value (0.01) is added avoiding undefined values.

```{r}
hist(
  customer_churn$TotalCharges,
  main = "Histogram of Total Charges",
  xlab = "Total Charges",
  col = "lightblue"
)
```

The numeric variables model fits the data very poorly (null deviance is 6418) although the residual deviance is slightly better (4990). The Akaike Information Criterion (AIC) which measures the trade-off between the fit and complexity of the model is 4998, which means that the model is not very parsimonious.

```{r}
model_numeric <- glm(
  Churn ~ tenure + MonthlyCharges + log(TotalCharges + 0.01),
  data = customer_churn,
  family = binomial
)
```

There is a heteroscedasticity problem, variance of the residuals is not constant across different values of the predictor nor the fitted values.

Null hypothesis can not be rejected, model is nonlinear, specially on the log variable.

Observations have large residuals, high leverage and high Cook's distance, meaning that they do not fit the model well and have a lot of influence on the model. 

```{r}
residualPlots(model_numeric)

marginalModelPlots(model_numeric)

library(effects)
plot(allEffects(model_numeric))

influencePlot(model_numeric)
```